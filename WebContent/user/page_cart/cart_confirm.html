<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>订单确认页</title>
		<link rel="SHORTCUT ICON" href="/shopping/chenchen.ico">
		<link rel="stylesheet" type="text/css" href="/shopping/css/shopping_common.css"/>
		<link rel="stylesheet" type="text/css" href="/shopping/user/page_goods/css/goods_common.css"/>
		<link rel="stylesheet" type="text/css" href="/shopping/user/page_cart/css/cart_confirm.css"/>
	</head>
	<body>
		<div class="page">

			<div class="top">
				<div class="top_inner">
					<div class="ti_left">
						<span>欢迎光临本站！</span>
						<a href="/shopping/user/page_goods/index.html">返回首页</a>
						<a href="/shopping/user/page_goods/index.html">~~~</a>
					</div>
					<div class="ti_center">
						<a href="#">adv</a>
					</div>
					<div class="ti_right">
						<a href="/shopping/user/page_user/center_orderlist.html">我的订单</a>&nbsp;
						<a href="/shopping/user/page_user/center.html">用户中心</a>&nbsp;
						<a href="/shopping/admin/login.html">管理员登录</a>&nbsp;
					</div>
					<div class="clear"></div>
				</div>
			</div>

			<div class="space20px"></div>
			<div class="head">
				<div class="head_inner">
					<div class="hi_logo">
						<a href="/shopping/user/page_goods/index.html">网站LOGO</a>
					</div>
					<div class="hi_search" style="float: right;">
						<form action="#" method="get">
							<input type="text" name="search_key" class="search_key"/>
							<input type="submit" value="搜索" class="search_submit" />
						</form>
					</div>
					<!--<div class="hi_cartbtn">
						<a href="../cart/cart.html" class="hic_cartbtn">购物车</a>
					</div>-->
					<div class="clear"></div>
				</div>
			</div>
			<div class="space20px"></div>


			<div class="nav">
				<div class="nav_inner">
					<div class="ni_categorys">
						<a class="nic_btna" href="JavaScript:void(0);">全部商品分类</a>
						<div class="nic_block" style="display: none;">
							<ul>
								<li>
									<h6>分类一</h6>
									<p>
										<a href="#">关键字1</a>
										<a href="#">关键字1</a>
										<a href="#">关键字1</a>
									</p>
								</li>
								<li>
									<h6>分类一</h6>
									<p>
										<a href="#">关键字1</a>
										<a href="#">关键字1</a>
										<a href="#">关键字1</a>
									</p>
								</li>
								<li>
									<h6>分类一</h6>
									<p>
										<a href="#">关键字1</a>
										<a href="#">关键字1</a>
										<a href="#">关键字1</a>
									</p>
								</li>
								<li>
									<h6>分类一</h6>
									<p>
										<a href="#">关键字1</a>
										<a href="#">关键字1</a>
										<a href="#">关键字1</a>
									</p>
								</li>
							</ul>
						</div>
					</div>
					<div class="ni_activity">
						<a href="#">满百包邮</a>
						<a href="#">充值优惠</a>
						<a href="#">新会员专区</a>
						<a href="#">每日开团</a>
						<a href="#">新品预告</a>
					</div>
					<div class="clear"></div>
				</div>
			</div>
			
			<div class="space10px"></div>
			<div class="main">
				<div class="main_inner">
					<div class="space10px"></div>
					<h1>填写并核对订单信息</h1>
					<div class="space10px"></div>
					<div class="mi_address">
						<h2>收货人信息</h2>
						<div class="space10px"></div>
						<div class="mia_list">
							<div class="mial_block mialb_active">
								<h6>江苏省南京市</h6>
								<h5>龚先生&nbsp;（收）</h5>
								<p>江宁区天元东路228号莱茵铂郡1088号<br><b>18994028888</b></p>
								<div class="mialb_operate">
									<a href="#">修改</a>
								</div>
							</div>
							<div class="mial_block">
								<h6>江苏省南京市</h6>
								<h5>龚先生&nbsp;（收）</h5>
								<p>江宁区天元东路228号莱茵铂郡1088号<br><b>18994028888</b></p>
								<div class="mialb_operate">
									&nbsp;
								</div>
							</div>
							<div class="mial_block">
								<h6>江苏省南京市</h6>
								<h5>龚先生&nbsp;（收）</h5>
								<p>江宁区天元东路228号莱茵铂郡1088号<br><b>18994028888</b></p>
								<div class="mialb_operate">
									&nbsp;
								</div>
							</div>
							<div class="mial_block">
								<h6>江苏省南京市</h6>
								<h5>龚先生&nbsp;（收）</h5>
								<p>江宁区天元东路228号莱茵铂郡1088号<br><b>18994028888</b></p>
								<div class="mialb_operate">
									&nbsp;
								</div>
							</div>
							<div class="clear"></div>
						</div>
						<div class="mia_tomgr">
							<a href="/shopping/user/page_user/center.html">管理收货地址</a>&nbsp;&nbsp;&nbsp;
						</div>
					</div>
					<div class="space10px"></div>

					<div class="mi_pay">
						<div class="space10px"></div>
						<h2>支付方式选择</h2>
						<div class="space10px"></div>
						<div class="mip_typelist">
							<a href="JavaScript:void(0);">微信支付</a>
							<a href="JavaScript:void(0);" class="mipt_active">支付宝支付</a>
							<a href="JavaScript:void(0);">易宝支付</a>
							<a href="JavaScript:void(0);">京东支付</a>
						</div>
					</div>
					<div class="space10px"></div>

					<div class="mi_order">
						<div class="space10px"></div>
						<h2>订单内容</h2>
						<div class="space10px"></div>
						<div class="mio_items">
							<div class="mioi_item">
								<div class="mioii_left">
									<a href="/shopping/user/page_user/center.html"><img src="../../goodsImg/goods.jpg"/></a>
								</div>
								<div class="mioii_right">
									<div class="space10px"></div>
									<p>【嘟嘟衣舍】韩国时尚前卫设计师最新力作潮的你哭不买就计师最新力作潮的你哭不买就后悔限量版</p>
									<div class="space20px"></div>
									<p>
										&nbsp;&nbsp;&nbsp;
										<span>单价：<b>18.80</b>元</span>
										&nbsp;&nbsp;&nbsp;
										<span>数量：<b>2</b>件</span>
										&nbsp;&nbsp;&nbsp;
										<span>小计：<b>37.60</b>元</span>
									</p>
								</div>
								<div class="clear"></div>
							</div>
							<div class="mioi_item">
								<div class="mioii_left">
									<a href="../page_goods/detail.html"><img src="../../goodsImg/goods.jpg"/></a>
								</div>
								<div class="mioii_right">
									<div class="space10px"></div>
									<p>【嘟嘟衣舍】韩国时尚前卫设计师最新力作潮的你哭不买就计师最新力作潮的你哭不买就后悔限量版</p>
									<div class="space20px"></div>
									<p>
										&nbsp;&nbsp;&nbsp;
										<span>单价：<b>18.80</b>元</span>
										&nbsp;&nbsp;&nbsp;
										<span>数量：<b>2</b>件</span>
										&nbsp;&nbsp;&nbsp;
										<span>小计：<b>37.60</b>元</span>
									</p>
								</div>
								<div class="clear"></div>
							</div>
							<div class="mioi_item">
								<div class="mioii_left">
									<a href="../page_goods/detail.html"><img src="../../goodsImg/goods.jpg"/></a>
								</div>
								<div class="mioii_right">
									<div class="space10px"></div>
									<p>【嘟嘟衣舍】韩国时尚前卫设计师最新力作潮的你哭不买就计师最新力作潮的你哭不买就后悔限量版</p>
									<div class="space20px"></div>
									<p>
										&nbsp;&nbsp;&nbsp;
										<span>单价：<b>18.80</b>元</span>
										&nbsp;&nbsp;&nbsp;
										<span>数量：<b>2</b>件</span>
										&nbsp;&nbsp;&nbsp;
										<span>小计：<b>37.60</b>元</span>
									</p>
								</div>
								<div class="clear"></div>
							</div>
							<div class="clear"></div>
						</div>
					</div>

					<div class="space20px"></div>
					<div class="mi_orderbar">
						<p class="miob_price">
							<span>应付金额：</span>
							<b>￥188.88</b>
						</p>
						<p class="miob_address">
							寄送至：江苏省南京市江宁区天元东路228号莱茵铂郡1088号&nbsp;&nbsp;收货人：龚先生 &nbsp;18994028888
						</p>
						<div class="space10px"></div>
					</div>
					<div class="space10px"></div>

					<div class="mi_ordersubmit">
						<a href="JavaScript:void(0);">提交订单</a>
					</div>
					
				</div>
			</div>
			<div class="space50px"></div>
			
			
			
			
			<div class="foot">
				<div class="foot_inner">
					<div class="fi_public">
						<a href="#">关于我们</a>
						<span>&nbsp;|&nbsp;</span>
						<a href="#">投资者</a>
						<span>&nbsp;|&nbsp;</span>
						<a href="#">加入我们</a>
						<span>&nbsp;|&nbsp;</span>
						<a href="#">联系我们</a>
						<span>&nbsp;|&nbsp;</span>
						<a href="#">网站地图</a>
						<span>&nbsp;|&nbsp;</span>
						<a href="#">法律声明</a>
					</div>
					<div class="space20px"></div>
					<p class="fi_copy">(c) Copyright 2016 new. All Rights Reserved. </p>
				</div>
			</div>
		</div>
		
<script src="/shopping/js/jQuery.1.8.3.min.js" type="text/javascript" charset="utf-8"></script>
<script src="/shopping/layer/layer.js" type="text/javascript" charset="utf-8"></script>
<script src="/shopping/js/shopping_common.js" type="text/javascript" charset="utf-8"></script>
<script src="/shopping/js/jquery.cookie.js" type="text/javascript" charset="utf-8"></script>
<script src="/shopping/js/getcategoryandkeys.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
$(function(){
	var user_name_cookie = $.cookie("user_name_cookie"); 
	var goods_ttnum = new Array();
	var goods_id_num = "";
	var consignee_name = "";
	var consignee_telnum = "";
	var consignee_address = "";
	var consignee_detail_address = "";
	var isaddress_valid_ornot = 0; //判断有没有收货地址或有没有选中收货地址，0代表没有收货地址，1代表有但是未选中，2代表有且选中了
	var priceTotal_val = 0;
	
	
	$.ajax({
		type:"post",
		url:"/shopping/user/getLogoAndCopyright.do",
		success:function(data){
			LogoAndCopyright_val = eval("("+data+")");
			$(".hi_logo a").attr("style","background: url(/img/"+LogoAndCopyright_val.logo_img+");");
			$(".fi_copy").text(LogoAndCopyright_val.copyright_detail);
		}
	});
	
	if(user_name_cookie == undefined || user_name_cookie == "null") {
		layer.alert("客官，您尚未登录，即将帮您跳转到登录页面~~", {icon: 5},function(){
			window.location.href = "/shopping/user/page_user/login.html?loginfrom=page_user/center.html";
		});
	} else {
		$(".ti_left").html("<span>欢迎光临本站！</span><a href='JavaScript:void(0);' class='logout_btn'>退出登录</a>");
	}
	
	$.ajax({
		type:"post",
		url:"/shopping/user/getUserAddresses.do",
		data:{"user_name":user_name_cookie},
		success:function(data) {
			var addresses = eval("("+data+")");
			var _html = "";
			if(addresses == "") {
				_html = "<strong>客官，您还没有收货地址，请添加！</strong>";
				isaddress_valid_ornot = 0;
			} else {
				isaddress_valid_ornot = 1;
				for (var i = 0; i < addresses.length; i++) {
					//alert(addresses[i].isDefault_address==1);
					if(addresses[i].isDefault_address == 1) {
						isaddress_valid_ornot = 2;
						_html += "<div class='mial_block mialb_active'>";
						consignee_name = addresses[i].consignee_name;
						consignee_telnum = addresses[i].consignee_telnum;
						consignee_detail_address = addresses[i].consignee_province + addresses[i].consignee_city + addresses[i].consignee_area + addresses[i].consignee_address;
						consignee_address = consignee_name + "," + consignee_telnum + "," + addresses[i].consignee_province + "," + addresses[i].consignee_city + "," + addresses[i].consignee_area + "," + addresses[i].consignee_address;
					} else if(addresses[i].isDefault_address == 0){
						
						_html += "<div class='mial_block'>";
					}
					_html += "<h6>"+addresses[i].consignee_province+"|"+addresses[i].consignee_city+"</h6>"
						  + "<h5>"+addresses[i].consignee_name+"&nbsp;（收）</h5>"
					      + "<p>"+addresses[i].consignee_area+"|"+addresses[i].consignee_address+"<br><b>"+addresses[i].consignee_telnum+"</b></p>"
					      + "<div class='mialb_operate'>";
					if(addresses[i].isDefault_address == 1) {
						_html += "&nbsp;";
					} else if(addresses[i].isDefault_address == 0){
						_html += "<a href='JavaScript:void(0);'>选中</a>";
					}
					_html += "</div>"
						   + "</div>";
						  //alert(_html);
					
				}
				_html += "<div class='clear'></div>";
			}
				$(".mi_address .mia_list").html(_html);
				$(".miob_address").html("寄送至："+ consignee_detail_address +"&nbsp;&nbsp;收货人："+ consignee_name +" &nbsp;"+ consignee_telnum);
		}
	});
	
	$.ajax({
		type:"post",
		url:"/shopping/user/getUserCart.do",
		data:{"user_name":user_name_cookie,"from":"cart"},
		success:function(data){
			if(data == "[]") {
				layer.alert("客官，您的购物车中没有商品，即将帮您跳转到主页~~", {icon: 5},function(){
					window.location.href = "/shopping/user/page_goods/index.html";
				});
			}
			var user_cart_goodsinfos = eval("("+data+")");
			var _html = "";
			for (var i = 0; i < user_cart_goodsinfos.length; i++) {
				//alert(user_cart_goodsinfos[i].goods_curprice);
				//alert(user_cart_goodsinfos[i].ischosen);
				
				if(user_cart_goodsinfos[i].ischosen == 1) {
					//alert(user_cart_goodsinfos[i].goods_num);
					priceTotal_val = priceTotal_val + parseInt(user_cart_goodsinfos[i].goods_num) * parseFloat(user_cart_goodsinfos[i].goods_curprice);
					goods_id_num = goods_id_num + user_cart_goodsinfos[i].goods_id + ":" + user_cart_goodsinfos[i].goods_num + ",";
					_html += "<div class='mioi_item'>"
					      + "<div class='mioii_left'>"
					      + "<a href='/shopping/user/page_goods/detail.html?goods_id="+ user_cart_goodsinfos[i].goods_id +"'><img src='/shopping/goodsImg/"+user_cart_goodsinfos[i].goods_img+"' alt=''/></a>"
				          + "</div>"
				          + "<div class='mioii_right'>"
						  + "<div class='space10px'></div>"
					      + "<p>"+user_cart_goodsinfos[i].goods_name+"</p>"
					      + "<div class='space20px'></div>"
					      + "<p>"
						  + "&nbsp;&nbsp;&nbsp;"
						  + "<span>单价：<b>"+new Number(user_cart_goodsinfos[i].goods_curprice).toFixed(2)+"</b>元</span>"
						  + "&nbsp;&nbsp;&nbsp;"
						  + "<span>数量：<b>"+user_cart_goodsinfos[i].goods_num+"</b>件</span>"
						  + "&nbsp;&nbsp;&nbsp;"
						  + "<span>小计：<b>"+new Number(user_cart_goodsinfos[i].goods_num*user_cart_goodsinfos[i].goods_curprice).toFixed(2)+"</b>元</span>"
					      + "</p>"
				          + "</div>"
				          + "<div class='clear'></div>"
						  + "</div>";
				}
			}
			$(".miob_price b").text("￥"+new Number(priceTotal_val).toFixed(2));
			_html += "<div class='clear'></div>";
			$(".mio_items").html(_html);
		}
	});
	
	$(".logout_btn").live("click", function(){
		$.cookie("user_name_cookie", null,{path: "/"});
		location.reload();
		//$.removeCookie("user_name_cookie");
		$(".ti_left").html("<span>欢迎光临本站！</span>"
						 + "<a href='/shopping/user/page_user/login.html?loginfrom=page_goods/index.html'>请登录</a>&nbsp;"
						 + "<a href='/shopping/user/page_user/register.html?regfrom=page_goods/index.html'>免费注册</a>");
	});
	
	$(".mialb_operate a").live("click",function(){
		consignee_name = $(this).parent().siblings("h5").html().split("&")[0];
		consignee_telnum = $(this).parent().siblings("p").children("b").html();
		var consignee_province = $(this).parent().siblings("h6").html().split("|")[0];
		var consignee_city = $(this).parent().siblings("h6").html().split("|")[1];
		var consignee_district = $(this).parent().siblings("p").html().split("<br>")[0].split("|")[0];
		var consignee_area = $(this).parent().siblings("p").html().split("<br>")[0].split("|")[1];
		//alert($(this).parent().siblings("p").html());
		consignee_detail_address = consignee_province + consignee_city + consignee_district + consignee_area;
		consignee_address = consignee_name + "," + consignee_telnum + "," + consignee_province + "," + consignee_city + "," + consignee_district + "," + consignee_area;
		$(this).parent().parent().parent().children(".mialb_active").children(".mialb_operate").html("<a href='JavaScript:void(0);'>选中</a>");
		$(this).parent().parent().parent().children(".mialb_active").removeClass("mialb_active");
		$(this).parent().parent().addClass("mialb_active");
		$(this).parent().html("&nbsp;");
		$(".miob_address").html("寄送至："+ consignee_detail_address +"&nbsp;&nbsp;收货人："+ consignee_name +" &nbsp;"+ consignee_telnum);
		isaddress_valid_ornot = 2;
	});
	
	$(".mi_pay .mip_typelist a").click(function(){
		$(this).parent(".mip_typelist").children(".mipt_active").removeClass("mipt_active");
		$(this).addClass("mipt_active");
	});
	
	$(".mi_ordersubmit a").click(function(){
		//alert("/shopping/user/user_order/order_created.html?userorder_id=ABC20160709121018888888&order_ttprice=" + priceTotal_val);
		//alert(consignee_address);
		//alert(goods_id_num);
		//alert(priceTotal_val);
	    if(isaddress_valid_ornot == 0){
	    	//alert("false");
	    	layer.alert("客官，您还没有填写收货地址，马上帮您跳转到用户中心添加~~", {icon: 5},function(){
				window.location.href = "/shopping/user/page_user/center.html";
			});
	    } else if(isaddress_valid_ornot == 1){
	    	layer.msg("客官，请选择一个收货地址~~");
	    } else if(isaddress_valid_ornot == 2){
	    	 $.ajax({
				type:"post",
				url:"/shopping/user/addUserOrder.do",
				data:{"user_name":user_name_cookie,"goods_id_num":goods_id_num,"order_ttprice":priceTotal_val,"order_address":consignee_address},
				success:function(msg){
					
					if(msg.split("|")[0] == "not_enough_goods_ttnum") {
						layer.alert("客官，您订单中的商品"+msg.split("|")[1]+"库存不足，马上帮您返回购物车页面重新选择~~", {icon: 5},function(){
							window.location.href = "/shopping/user/page_cart/cart.html";
						});
					} else if(msg.split("|")[0] == "success"){
						window.location.href = "/shopping/user/user_order/order_created.html?userorder_id=" + msg.split("|")[1] + "&order_ttprice=" + new Number(priceTotal_val).toFixed(2);
					}
				}
			}); 
	    }
	});
	
});
</script>
	</body>
</html>
